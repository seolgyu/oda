<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hs.mapper.PostMapper">

    <insert id="insertPost" parameterType="com.hs.model.PostDTO">
        INSERT INTO POSTS (
            POST_ID, USER_NUM, COMMUNITY_ID, TITLE, CONTENT,
            POST_TYPE, IS_DELETED, CREATED_DATE, STATE,
            REPLY_ENABLED, SHOW_LIKES, SHOW_VIEWS
        ) VALUES (
            POSTS_SEQ.NEXTVAL, 
            #{userNum}, 
            #{communityId, jdbcType=INTEGER},
            #{title}, 
            #{content}, 
            #{postType},
            '0', 
            SYSTIMESTAMP,
            #{state},
            #{replyEnabled}, 
            #{showLikes}, 
            #{showViews} 
        )
        <selectKey keyProperty="postId" resultType="long" order="AFTER">
            SELECT POSTS_SEQ.CURRVAL FROM DUAL
        </selectKey>
    </insert>

    <update id="updatePost" parameterType="com.hs.model.PostDTO">
        UPDATE POSTS
        SET TITLE = #{title},
            CONTENT = #{content},
            UPDATED_DATE = SYSTIMESTAMP,
            STATE = #{state},
            REPLY_ENABLED = #{replyEnabled},
            SHOW_LIKES = #{showLikes},
            SHOW_VIEWS = #{showViews}
        WHERE POST_ID = #{postId} 
          AND USER_NUM = #{userNum}
    </update>

    <update id="deletePost" parameterType="long">
        UPDATE POSTS 
        SET IS_DELETED = '1' 
        WHERE POST_ID = #{postId}
    </update>

	<select id="findById" parameterType="long" resultMap="postMap">
        SELECT
            p.POST_ID AS postId,
            p.USER_NUM AS userNum,
            p.COMMUNITY_ID AS communityId,
            p.TITLE,
            p.CONTENT,
            p.POST_TYPE AS postType,
            p.VIEW_COUNT AS viewCount,
            p.LIKE_COUNT AS likeCount,
            (SELECT COUNT(*) FROM COMMENTS WHERE POST_ID = p.POST_ID AND IS_DELETED = '0') AS commentCount,
            p.CREATED_DATE AS createdDate,
            p.UPDATED_DATE AS updatedDate,
            p.STATE,
            p.REPLY_ENABLED AS replyEnabled,
            p.SHOW_LIKES AS showLikes,
            p.SHOW_VIEWS AS showViews,
            u.USER_NICKNAME AS authorNickname,
            u.USER_PROFILE AS authorProfileImage,
            f.FILE_AT_ID AS fileAtId,
            f.FILE_PATH AS filePath,
            f.FILE_TYPE AS fileType,
            f.FILE_ORDER AS fileOrder
        FROM POSTS p
        JOIN MEMBER u ON p.USER_NUM = u.USER_NUM
        LEFT JOIN FILEAT f ON p.POST_ID = f.POST_ID
        WHERE p.POST_ID = #{postId}
        ORDER BY f.FILE_ORDER ASC
    </select>   
   
    <select id="listPost" resultType="com.hs.model.PostDTO">
        SELECT
            p.POST_ID AS postId,
            p.USER_NUM AS userNum,
            p.TITLE,
            p.VIEW_COUNT AS viewCount,
            p.LIKE_COUNT AS likeCount,
            p.CREATED_DATE AS createdDate,
            u.USER_NICKNAME AS authorNickname,
            NULL AS authorProfileImage
        FROM POSTS p
        JOIN MEMBER u ON p.USER_NUM = u.USER_NUM
        WHERE p.IS_DELETED = '0'
        ORDER BY p.POST_ID DESC
    </select>
    
    <select id="listUserPost" parameterType="map" resultType="com.hs.model.PostDTO">
        SELECT
            p.POST_ID AS postId,
            p.USER_NUM AS userNum,
            p.COMMUNITY_ID AS communityId,
            p.TITLE,
            p.CONTENT,
            p.POST_TYPE AS postType,
            p.VIEW_COUNT AS viewCount,
            p.LIKE_COUNT AS likeCount,
            (SELECT COUNT(*) FROM COMMENTS WHERE POST_ID = p.POST_ID AND IS_DELETED = '0') AS commentCount,
            p.CREATED_DATE AS createdDate,
            p.UPDATED_DATE AS updatedDate,
            p.STATE,
            p.REPLY_ENABLED AS replyEnabled,
            p.SHOW_LIKES AS showLikes,
            p.SHOW_VIEWS AS showViews,
            u.USER_NICKNAME AS authorNickname,
            u.USER_ID AS authorId,
            u.USER_PROFILE AS authorProfileImage
        FROM POSTS p
        JOIN MEMBER u ON p.USER_NUM = u.USER_NUM
        WHERE p.USER_NUM = #{userNum}
          AND p.IS_DELETED = '0'
        ORDER BY p.POST_ID DESC
        OFFSET #{offset} ROWS FETCH FIRST #{size} ROWS ONLY
    </select>
    
    <select id="listUserRepost" parameterType="map" resultType="com.hs.model.PostDTO">
        SELECT
            p.POST_ID AS postId,
            p.USER_NUM AS userNum,
            p.COMMUNITY_ID AS communityId,
            p.TITLE,
            p.CONTENT,
            p.POST_TYPE AS postType,
            p.VIEW_COUNT AS viewCount,
            p.LIKE_COUNT AS likeCount,
            (SELECT COUNT(*) FROM COMMENTS WHERE POST_ID = p.POST_ID AND IS_DELETED = '0') AS commentCount,
            p.CREATED_DATE AS createdDate,
            p.UPDATED_DATE AS updatedDate,
            p.STATE,
            p.REPLY_ENABLED AS replyEnabled,
            p.SHOW_LIKES AS showLikes,
            p.SHOW_VIEWS AS showViews,
            u.USER_NICKNAME AS authorNickname,
            u.USER_ID AS authorId,
            u.USER_PROFILE AS authorProfileImage,
            r.REPOST_DATE AS repostDate
        FROM REPOST r
        JOIN POSTS p ON r.POST_ID = p.POST_ID
        JOIN MEMBER u ON p.USER_NUM = u.USER_NUM
        WHERE r.USER_NUM = #{userNum}
          AND p.IS_DELETED = '0'
        ORDER BY r.REPOST_DATE DESC
        OFFSET #{offset} ROWS FETCH FIRST #{size} ROWS ONLY
    </select>

    <insert id="insertFileAt" parameterType="com.hs.model.FileAtDTO">
        INSERT INTO FILEAT (
            FILE_AT_ID, FILE_NAME, FILE_PATH, FILE_SIZE,
            FILE_TYPE, FILE_ORDER, UPLOADED_DATE, POST_ID
        ) VALUES (
            FILEAT_SEQ.NEXTVAL, 
            #{fileName},
            #{filePath}, 
            #{fileSize},
            #{fileType}, 
            #{fileOrder}, 
            SYSTIMESTAMP,
            #{postId}
        )
    </insert>

    <update id="updateHitCount" parameterType="long">
        UPDATE POSTS 
        SET VIEW_COUNT = VIEW_COUNT + 1 
        WHERE POST_ID = #{postId}
    </update>

    <select id="listFileAt" parameterType="long" resultType="com.hs.model.FileAtDTO">
        SELECT
            FILE_AT_ID AS fileAtId,
            FILE_NAME AS fileName,
            FILE_PATH AS filePath,
            FILE_SIZE AS fileSize,
            FILE_TYPE AS fileType,
            FILE_ORDER AS fileOrder,
            UPLOADED_DATE AS uploadedDate,
            POST_ID AS postId
        FROM FILEAT
        WHERE POST_ID = #{postId}
        ORDER BY FILE_ORDER ASC
    </select>

    <delete id="deleteFileAt" parameterType="long">
        DELETE FROM FILEAT 
        WHERE FILE_AT_ID = #{fileAtId}
    </delete>

    <resultMap id="postMap" type="com.hs.model.PostDTO">
        <id property="postId" column="postId" />
        <result property="userNum" column="userNum" />
        <result property="title" column="title" />
        <result property="content" column="content" />
        <result property="viewCount" column="viewCount" />
        <result property="likeCount" column="likeCount" />
        <result property="commentCount" column="commentCount" />
        <result property="createdDate" column="createdDate" />
        <result property="authorNickname" column="authorNickname" />
        <result property="authorProfileImage" column="authorProfileImage" />
        <result property="likedByUser" column="likedByUser" />
        <result property="showLikes" column="showLikes" />
        <result property="showViews" column="showViews" />
        <result property="state" column="state" />
        <result property="savedByUser" column="savedByUser" />
        <result property="repostedByUser" column="repostedByUser" />
        
        
        <collection property="fileList" ofType="com.hs.model.FileAtDTO">
            <id property="fileAtId" column="fileAtId" />
            <result property="filePath" column="filePath" />
            <result property="fileOrder" column="fileOrder" />
            <result property="fileType" column="fileType" />
        </collection>
    </resultMap>

    <select id="listPostMain" parameterType="map" resultMap="postMap">
        SELECT
            p.POST_ID AS postId,
            p.USER_NUM AS userNum,
            p.TITLE AS title,
            p.CONTENT AS content,
            p.VIEW_COUNT AS viewCount,
            p.LIKE_COUNT AS likeCount,
            (SELECT COUNT(*) FROM COMMENTS WHERE POST_ID = p.POST_ID AND IS_DELETED = '0') AS commentCount,
            TO_CHAR(p.CREATED_DATE, 'YYYY-MM-DD HH24:MI:SS') AS createdDate,
            p.SHOW_LIKES AS showLikes,
            p.SHOW_VIEWS AS showViews,
            p.STATE AS state,
			NVL((SELECT COUNT(*) FROM SAVED WHERE POST_ID = p.POST_ID AND USER_NUM = #{userNum}), 0) AS savedByUser,
			NVL((SELECT COUNT(*) FROM REPOST WHERE POST_ID = p.POST_ID AND USER_NUM = #{userNum}), 0) AS repostedByUser,
            NVL(u.USER_NICKNAME, 'Unknown') AS authorNickname,
            u.USER_PROFILE AS authorProfileImage,
            NVL((SELECT COUNT(*) FROM LIKES WHERE POST_ID = p.POST_ID AND USER_NUM = #{userNum}), 0) AS likedByUser,
            f.FILE_AT_ID AS fileAtId,
            f.FILE_PATH AS filePath,
            f.FILE_TYPE AS fileType,
            f.FILE_ORDER AS fileOrder

        FROM (
            SELECT P_SUB.* FROM POSTS P_SUB
            WHERE P_SUB.IS_DELETED = '0'
            
            AND (
                P_SUB.STATE = '정상' 
                OR 
                (P_SUB.STATE = '나만보기' AND P_SUB.USER_NUM = #{userNum})
            )

            <if test="keyword != null and keyword != ''">
                AND (
                    INSTR(P_SUB.TITLE, #{keyword}) &gt; 0 
                    OR 
                    INSTR(P_SUB.CONTENT, #{keyword}) &gt; 0
                    OR
                    EXISTS (
                        SELECT 1 FROM COMMENTS c 
                        WHERE c.POST_ID = P_SUB.POST_ID 
                          AND c.IS_DELETED = '0' 
                          AND INSTR(c.CONTENT, #{keyword}) &gt; 0
                    )
                )
            </if>

            <choose>
                <when test="sort == 'likes'">
                    ORDER BY P_SUB.LIKE_COUNT DESC, P_SUB.POST_ID DESC
                </when>
                <when test="sort == 'views'">
                    ORDER BY P_SUB.VIEW_COUNT DESC, P_SUB.POST_ID DESC
                </when>
                <otherwise>
                    ORDER BY P_SUB.POST_ID DESC
                </otherwise>
            </choose>
            
            OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
        ) p
        LEFT JOIN MEMBER u ON p.USER_NUM = u.USER_NUM
        LEFT JOIN FILEAT f ON p.POST_ID = f.POST_ID

        <choose>
            <when test="sort == 'likes'">
                ORDER BY p.LIKE_COUNT DESC, p.POST_ID DESC, NVL(f.FILE_ORDER, 0) ASC
            </when>
            <when test="sort == 'views'">
                ORDER BY p.VIEW_COUNT DESC, p.POST_ID DESC, NVL(f.FILE_ORDER, 0) ASC
            </when>
            <otherwise>
                ORDER BY p.POST_ID DESC, NVL(f.FILE_ORDER, 0) ASC
            </otherwise>
        </choose>
    </select>

    <insert id="insertPostLike" parameterType="map">
        INSERT INTO LIKES (POST_ID, USER_NUM, CREATED_DATE) 
        VALUES (#{postId}, #{userNum}, SYSDATE)
    </insert>

    <delete id="deletePostLike" parameterType="map">
        DELETE FROM LIKES
        WHERE POST_ID = #{postId} AND USER_NUM = #{userNum}
    </delete>

    <select id="countPostLike" parameterType="Long" resultType="Integer">
        SELECT COUNT(*) FROM LIKES WHERE POST_ID = #{postId}
    </select>

    <update id="updatePostLikeCount" parameterType="Long">
        UPDATE POSTS 
        SET LIKE_COUNT = (SELECT COUNT(*) FROM LIKES WHERE POST_ID = #{postId})
        WHERE POST_ID = #{postId}
    </update>

    <select id="checkPostLiked" parameterType="map" resultType="Integer">
        SELECT COUNT(*) FROM LIKES 
        WHERE POST_ID = #{postId} AND USER_NUM = #{userNum}
    </select>

    <insert id="insertComment" parameterType="com.hs.model.CommentDTO">
    	<selectKey keyProperty="commentId" resultType="long" order="AFTER">
        	SELECT COMMENTS_SEQ.CURRVAL FROM DUAL
    	</selectKey>
        INSERT INTO COMMENTS (
            COMMENT_ID, POST_ID, USER_NUM,
            USER_ID, CONTENT,
            PARENT_COMMENT_ID, CREATED_DATE, IS_DELETED
        ) VALUES (
            COMMENTS_SEQ.NEXTVAL, #{postId}, #{userNum}, #{userId}, #{content},
            NULLIF(#{parentCommentId}, 0), SYSDATE, '0'
        )
    </insert>

    <update id="updateComment" parameterType="com.hs.model.CommentDTO">
        UPDATE COMMENTS
        SET CONTENT = #{content}, 
            UPDATED_DATE = SYSDATE
        WHERE COMMENT_ID = #{commentId} AND USER_NUM = #{userNum}
    </update>

    <delete id="deleteComment" parameterType="Long">
        DELETE FROM COMMENTS
        WHERE COMMENT_ID = #{commentId}
    </delete>

    <select id="listComment" parameterType="map" resultType="com.hs.model.CommentDTO">
        SELECT
            c.COMMENT_ID AS commentId,
            c.POST_ID AS postId,
            c.USER_NUM AS userNum,
            c.CONTENT AS content,
            TO_CHAR(c.CREATED_DATE, 'YYYY-MM-DD HH24:MI') AS createdDate,
            c.PARENT_COMMENT_ID AS parentCommentId,
            c.IS_DELETED AS isDeleted,
            m.USER_NICKNAME AS userNickName,
            m.USER_PROFILE AS profileImage,
            m.USER_ID AS userId,
            (SELECT COUNT(*) FROM COMMENTS_LIKES cl WHERE cl.COMMENT_ID = c.COMMENT_ID) AS likeCount,
            NVL((SELECT COUNT(*) FROM COMMENTS_LIKES cl WHERE cl.COMMENT_ID = c.COMMENT_ID AND cl.USER_NUM = #{userNum}), 0) AS likedByUser
        FROM COMMENTS c
        JOIN MEMBER m ON c.USER_NUM = m.USER_NUM
        WHERE c.POST_ID = #{postId}
        START WITH c.PARENT_COMMENT_ID IS NULL
        CONNECT BY PRIOR c.COMMENT_ID = c.PARENT_COMMENT_ID
        ORDER SIBLINGS BY c.CREATED_DATE ASC
    </select>

    <update id="updatePostCommentCount" parameterType="long">
        UPDATE POSTS
        SET COMMENT_COUNT = (
            SELECT COUNT(*)
            FROM COMMENTS
            WHERE POST_ID = #{postId} AND IS_DELETED = '0'
        )
        WHERE POST_ID = #{postId}
    </update>

    <insert id="insertCommentLike" parameterType="map">
        INSERT INTO COMMENTS_LIKES (COMMENT_ID, USER_NUM, CREATED_DATE) 
        VALUES (#{commentId}, #{userNum}, SYSDATE)
    </insert>

    <delete id="deleteCommentLike" parameterType="map">
        DELETE FROM COMMENTS_LIKES 
        WHERE COMMENT_ID = #{commentId} AND USER_NUM = #{userNum}
    </delete>

    <select id="countCommentLike" parameterType="Long" resultType="Integer">
        SELECT COUNT(*) FROM COMMENTS_LIKES WHERE COMMENT_ID = #{commentId}
    </select>

    <select id="checkCommentLiked" parameterType="map" resultType="Integer">
        SELECT COUNT(*) FROM COMMENTS_LIKES 
        WHERE COMMENT_ID = #{commentId} AND USER_NUM = #{userNum}
    </select>

    <select id="getPostIdByCommentId" parameterType="long" resultType="long">
        SELECT POST_ID FROM COMMENTS WHERE COMMENT_ID = #{commentId}
    </select>

    <insert id="insertReport" parameterType="com.hs.model.ReportDTO">
        INSERT INTO Report (
            REPORT_NUM, REPORT_USER_NUM, REPORT_REASON, 
            REPORT_TYPE, REPORT_CONTENT, REPORT_DATE
        ) VALUES (
            REPORT_SEQ.NEXTVAL, #{reportUserNum}, #{reportReason},
            #{reportType}, #{reportContent}, SYSDATE
        )
    </insert>

    <update id="updatePostReportCount" parameterType="long">
        UPDATE POSTS 
        SET REPORT_COUNT = NVL(REPORT_COUNT, 0) + 1
        WHERE POST_ID = #{postId}
    </update>
    
    <select id="checkReportHistory" parameterType="map" resultType="int">
        SELECT COUNT(*) FROM Report
        WHERE REPORT_USER_NUM = #{userNum} 
          AND REPORT_CONTENT = TO_CHAR(#{postId})
          AND REPORT_TYPE = 'POST'
    </select>

    <select id="findTempPost" parameterType="long" resultType="com.hs.model.PostDTO">
        SELECT 
            POST_ID AS postId, 
            USER_NUM AS userNum, 
            TITLE, 
            CONTENT, 
            STATE
        FROM POSTS 
        WHERE USER_NUM = #{userNum} 
          AND STATE = '임시저장' 
          AND IS_DELETED = '0'
        ORDER BY POST_ID DESC
        FETCH FIRST 1 ROWS ONLY
    </select>
    
	<select id="listCommunityPost" parameterType="map" resultType="com.hs.model.PostDTO">
	    SELECT * FROM (
	        SELECT
	            p.POST_ID AS postId,
	            p.USER_NUM AS userNum,
	            p.COMMUNITY_ID AS communityId,
	            p.TITLE,
	            p.CONTENT,
	            p.VIEW_COUNT AS viewCount,
	            p.LIKE_COUNT AS likeCount,
	            (SELECT COUNT(*) FROM COMMENTS WHERE POST_ID = p.POST_ID AND IS_DELETED = '0') AS commentCount,
	            p.CREATED_DATE AS createdDate,
	            p.STATE,
	            u.USER_NICKNAME AS authorNickname,
	            u.USER_ID AS authorId,
	            u.USER_PROFILE AS authorProfileImage,
	            CASE WHEN EXISTS (SELECT 1 FROM SAVED ps WHERE ps.POST_ID = p.POST_ID AND ps.USER_NUM = #{user_num}) THEN 1 ELSE 0 END AS savedByUser,
	            CASE WHEN EXISTS (SELECT 1 FROM REPOST pr WHERE pr.POST_ID = p.POST_ID AND pr.USER_NUM = #{user_num}) THEN 1 ELSE 0 END AS repostedByUser
	        FROM POSTS p
	        LEFT JOIN MEMBER u ON p.USER_NUM = u.USER_NUM
	        WHERE p.COMMUNITY_ID = #{community_id}
	          AND p.IS_DELETED = '0'
	          AND (TRIM(p.STATE) = '정상' OR (TRIM(p.STATE) = '나만보기' AND p.USER_NUM = #{user_num, jdbcType=BIGINT}))
	    ) 
	    ORDER BY 
	    <choose>
	        <when test="sort == 'views'">viewCount DESC, postId DESC</when>
	        <when test="sort == 'comments'">commentCount DESC, postId DESC</when>
	        <otherwise>postId DESC</otherwise>
	    </choose>
	    OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
	</select>
	
	<insert id="insertPostSave" parameterType="map">
        INSERT INTO SAVED (SAVE_ID, USER_NUM, POST_ID, SAVED_DATE)
        VALUES (SAVED_SEQ.NEXTVAL, #{userNum}, #{postId}, SYSDATE)
    </insert>

    <delete id="deletePostSave" parameterType="map">
        DELETE FROM SAVED WHERE POST_ID = #{postId} AND USER_NUM = #{userNum}
    </delete>

    <select id="checkPostSaved" parameterType="map" resultType="Integer">
        SELECT COUNT(*) FROM SAVED WHERE POST_ID = #{postId} AND USER_NUM = #{userNum}
    </select>


    <insert id="insertPostRepost" parameterType="map">
        INSERT INTO REPOST (REPOST_ID, USER_NUM, POST_ID, REPOST_DATE)
        VALUES (REPOST_SEQ.NEXTVAL, #{userNum}, #{postId}, SYSDATE)
    </insert>

    <delete id="deletePostRepost" parameterType="map">
        DELETE FROM REPOST WHERE POST_ID = #{postId} AND USER_NUM = #{userNum}
    </delete>
    
    <select id="checkPostReposted" parameterType="map" resultType="Integer">
        SELECT COUNT(*) FROM REPOST WHERE POST_ID = #{postId} AND USER_NUM = #{userNum}
    </select>
    
    <select id="listSavedPost" parameterType="map" resultMap="postMap">
        SELECT
            p.POST_ID AS postId,
            p.USER_NUM AS userNum,
            p.TITLE AS title,
            p.CONTENT AS content,
            p.VIEW_COUNT AS viewCount,
            p.LIKE_COUNT AS likeCount,
            (SELECT COUNT(*) FROM COMMENTS WHERE POST_ID = p.POST_ID AND IS_DELETED = '0') AS commentCount,
            TO_CHAR(p.CREATED_DATE, 'YYYY-MM-DD HH24:MI:SS') AS createdDate,
            p.SHOW_LIKES AS showLikes,
            p.SHOW_VIEWS AS showViews,
            p.STATE AS state,
            u.USER_NICKNAME AS authorNickname,
            u.USER_PROFILE AS authorProfileImage,
           
            NVL((SELECT COUNT(*) FROM LIKES WHERE POST_ID = p.POST_ID AND USER_NUM = #{userNum}), 0) AS likedByUser,
            1 AS savedByUser, -- 저장 목록이니까 무조건 true
            NVL((SELECT COUNT(*) FROM REPOST WHERE POST_ID = p.POST_ID AND USER_NUM = #{userNum}), 0) AS repostedByUser,

            f.FILE_AT_ID AS fileAtId,
            f.FILE_PATH AS filePath
        FROM SAVED s
        JOIN POSTS p ON s.POST_ID = p.POST_ID
        JOIN MEMBER u ON p.USER_NUM = u.USER_NUM
        LEFT JOIN FILEAT f ON p.POST_ID = f.POST_ID AND f.FILE_ORDER = 0 -- 썸네일(첫번째 사진)만
        WHERE s.USER_NUM = #{targetUserNum} -- 내 피드 주인
          AND p.IS_DELETED = '0'
        ORDER BY s.SAVED_DATE DESC
        OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
    </select>

    <select id="listRepostedPost" parameterType="map" resultMap="postMap">
        SELECT
            p.POST_ID AS postId,
            p.USER_NUM AS userNum,
            p.TITLE AS title,
            p.CONTENT AS content,
            p.VIEW_COUNT AS viewCount,
            p.LIKE_COUNT AS likeCount,
            (SELECT COUNT(*) FROM COMMENTS WHERE POST_ID = p.POST_ID AND IS_DELETED = '0') AS commentCount,
            TO_CHAR(p.CREATED_DATE, 'YYYY-MM-DD HH24:MI:SS') AS createdDate,
            p.SHOW_LIKES AS showLikes,
            p.SHOW_VIEWS AS showViews,
            p.STATE AS state,
            u.USER_NICKNAME AS authorNickname,
            u.USER_PROFILE AS authorProfileImage,

            NVL((SELECT COUNT(*) FROM LIKES WHERE POST_ID = p.POST_ID AND USER_NUM = #{userNum}), 0) AS likedByUser,
            NVL((SELECT COUNT(*) FROM SAVED WHERE POST_ID = p.POST_ID AND USER_NUM = #{userNum}), 0) AS savedByUser,
            1 AS repostedByUser, 

            f.FILE_AT_ID AS fileAtId,
            f.FILE_PATH AS filePath
        FROM REPOST r
        JOIN POSTS p ON r.POST_ID = p.POST_ID
        JOIN MEMBER u ON p.USER_NUM = u.USER_NUM
        LEFT JOIN FILEAT f ON p.POST_ID = f.POST_ID AND f.FILE_ORDER = 0
        WHERE r.USER_NUM = #{targetUserNum}
          AND p.IS_DELETED = '0'
        ORDER BY r.REPOST_DATE DESC
        OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
    </select>
    
    <select id="getPostAuthorNum" parameterType="Long" resultType="Long">
    	SELECT user_num
    	FROM posts
    	WHERE post_id = #{postId}
    </select>
    
    <select id="getCommentWriterNum" parameterType="Long" resultType="Long">
    	SELECT user_num
    	FROM comments
    	WHERE comment_id = #{commentId}
    </select>
    
    <select id="getCommentInfo" parameterType="Long" resultType="com.hs.model.CommentDTO">
	    SELECT 
	        COMMENT_ID AS commentId, 
	        POST_ID AS postId, 
	        USER_NUM AS userNum,
	        USER_ID AS userId, 
	        CONTENT AS content,
	        CREATED_DATE AS createdDate,
	        PARENT_COMMENT_ID AS parentCommentId,
	        IS_DELETED AS isDeleted
	    FROM COMMENTS c
	    WHERE COMMENT_ID = #{commentId}
    </select>
	
</mapper>