<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hs.mapper.PostMapper">

	<insert id="insertPost" parameterType="com.hs.model.PostDTO">
		INSERT INTO posts (
		post_id, user_num, community_id, title, content,
		post_type, is_deleted, created_date, state,
		reply_enabled, show_likes, show_views
		)
		VALUES (
		posts_seq.NEXTVAL, #{userNum}, #{communityId,
		jdbcType=INTEGER},
		#{title}, #{content}, #{postType},
		'0', SYSTIMESTAMP,
		#{state},
		#{replyEnabled}, #{showLikes}, #{showViews} )
		<selectKey keyProperty="postId" resultType="long"
			order="AFTER">
			SELECT posts_seq.CURRVAL FROM DUAL
		</selectKey>
	</insert>

	<update id="updatePost" parameterType="com.hs.model.PostDTO">
		UPDATE posts
		SET title =
		#{title}, content = #{content},
		updated_date = SYSTIMESTAMP, state =
		#{state},
		reply_enabled = #{replyEnabled}, show_likes = #{showLikes}, show_views = #{showViews}
		WHERE post_id = #{postId} AND user_num = #{userNum}
	</update>

	<update id="deletePost" parameterType="long">
		UPDATE POSTS SET
		IS_DELETED = '1' WHERE POST_ID = #{postId}
	</update>

	<select id="findById" parameterType="long"
		resultType="com.hs.model.PostDTO">
		SELECT
		p.post_id AS postId,
		p.user_num AS userNum,
		p.community_id AS communityId,
		p.title,
		p.content,
		p.post_type AS
		postType,
		p.view_count AS viewCount,
		p.like_count AS likeCount,
		(SELECT
		COUNT(*) FROM COMMENTS WHERE POST_ID = p.POST_ID AND IS_DELETED =
		'0')
		AS commentCount,
		p.created_date AS createdDate,
		p.updated_date AS
		updatedDate,
		p.state,
		p.reply_enabled AS replyEnabled,
		p.show_likes AS showLikes,
		p.show_views AS showViews,
		u.user_nickname AS authorNickname,
		u.user_profile AS
		authorProfileImage
		FROM posts p
		JOIN member u ON p.user_num = u.user_num
		WHERE p.post_id = #{postId}
	</select>

	<select id="listPost" resultType="com.hs.model.PostDTO">
		SELECT
		p.post_id AS postId,
		p.user_num AS userNum,
		p.title,
		p.view_count AS viewCount,
		p.like_count
		AS likeCount,
		p.created_date AS createdDate,
		u.user_nickname AS
		authorNickname,
		NULL AS authorProfileImage
		FROM posts p
		JOIN member u ON
		p.user_num = u.user_num
		WHERE p.is_deleted = '0'
		ORDER BY p.post_id DESC
	</select>
	
	<select id="listUserPost" parameterType="map"
		resultType="com.hs.model.PostDTO">
		SELECT
		p.post_id AS postId,
		p.user_num AS userNum,
		p.community_id AS communityId,
		p.title,
		p.content,
		p.post_type AS
		postType,
		p.view_count AS viewCount,
		p.like_count AS likeCount,
		(SELECT
		COUNT(*) FROM COMMENTS WHERE POST_ID = p.POST_ID AND IS_DELETED =
		'0')
		AS commentCount,
		p.created_date AS createdDate,
		p.updated_date AS
		updatedDate,
		p.state,
		p.reply_enabled AS replyEnabled,
		p.show_likes AS showLikes,
		p.show_views AS showViews,
		u.user_nickname AS authorNickname,
		u.user_id AS authorId,
		u.user_profile AS
		authorProfileImage
		FROM posts p
		JOIN member u ON p.user_num = u.user_num
		WHERE p.user_num = #{userNum}
		AND p.is_deleted = '0'
		ORDER BY p.post_id DESC
		OFFSET #{offset} ROWS FETCH FIRST #{size} ROWS ONLY
	</select>

	<insert id="insertFileAt" parameterType="com.hs.model.FileAtDTO">
		INSERT INTO FILEAT (
		file_at_id, file_name, file_path, file_size,
		file_type, file_order,
		uploaded_date, post_id
		) VALUES (
		fileat_seq.NEXTVAL, #{fileName},
		#{filePath}, #{fileSize},
		#{fileType}, #{fileOrder}, SYSTIMESTAMP,
		#{postId}
		)
	</insert>

	<update id="updateHitCount" parameterType="long">
		UPDATE posts SET
		view_count = view_count + 1 WHERE post_id = #{postId}
	</update>

	<select id="listFileAt" parameterType="long"
		resultType="com.hs.model.FileAtDTO">
		SELECT
		file_at_id AS fileAtId,
		file_name AS fileName,
		file_path AS filePath,
		file_size AS fileSize,
		file_type AS fileType,
		file_order AS fileOrder,
		uploaded_date AS uploadedDate,
		post_id AS
		postId
		FROM FILEAT
		WHERE post_id = #{postId}
		ORDER BY file_order ASC
	</select>

	<delete id="deleteFileAt" parameterType="long">
		DELETE FROM FILEAT WHERE
		FILE_AT_ID = #{fileAtId}
	</delete>

	<resultMap id="postMap" type="com.hs.model.PostDTO">
		<id property="postId" column="postId" />
		<result property="userNum" column="userNum" />
		<result property="title" column="title" />
		<result property="content" column="content" />
		<result property="viewCount" column="viewCount" />
		<result property="likeCount" column="likeCount" />
		<result property="commentCount" column="commentCount" />
		<result property="createdDate" column="createdDate" />
		<result property="authorNickname" column="authorNickname" />
		<result property="authorProfileImage" column="authorProfileImage" />
		<result property="likedByUser" column="likedByUser" />
		<result property="showLikes" column="showLikes" />
    	<result property="showViews" column="showViews" />
   		<result property="state" column="state" />
		
		<collection property="fileList" ofType="com.hs.model.FileAtDTO">
			<id property="fileAtId" column="fileAtId" />
			<result property="filePath" column="filePath" />
			<result property="fileOrder" column="fileOrder" />
		</collection>
	</resultMap>

	<select id="listPostMain" parameterType="map" resultMap="postMap">
        SELECT
            p.POST_ID AS postId,
            p.USER_NUM AS userNum,
            p.TITLE AS title,
            p.CONTENT AS content,
            p.VIEW_COUNT AS viewCount,
            p.LIKE_COUNT AS likeCount,
            (SELECT COUNT(*) FROM COMMENTS WHERE POST_ID = p.POST_ID AND IS_DELETED = '0') AS commentCount,
            TO_CHAR(p.CREATED_DATE, 'YYYY-MM-DD HH24:MI:SS') AS createdDate,
            p.SHOW_LIKES AS showLikes,
            p.SHOW_VIEWS AS showViews,
            p.STATE AS state,

            NVL(u.USER_NICKNAME, 'Unknown') AS authorNickname,
            u.USER_PROFILE AS authorProfileImage,

            NVL((SELECT COUNT(*) FROM LIKES WHERE POST_ID = p.POST_ID AND USER_NUM = #{userNum}), 0) AS likedByUser,

            f.FILE_AT_ID AS fileAtId,
            f.FILE_PATH AS filePath,
            f.FILE_ORDER AS fileOrder

        FROM (
            SELECT P_SUB.* FROM POSTS P_SUB
            WHERE P_SUB.IS_DELETED = '0'
            
            AND (
                P_SUB.STATE = '정상' 
                OR 
                (P_SUB.STATE = '나만보기' AND P_SUB.USER_NUM = #{userNum})
            )

            <if test="keyword != null and keyword != ''">
                AND (
                    INSTR(P_SUB.TITLE, #{keyword}) &gt; 0 
                    OR 
                    INSTR(P_SUB.CONTENT, #{keyword}) &gt; 0
                    OR
                    EXISTS (
                        SELECT 1 FROM COMMENTS c 
                        WHERE c.POST_ID = P_SUB.POST_ID 
                          AND c.IS_DELETED = '0' 
                          AND INSTR(c.CONTENT, #{keyword}) &gt; 0
                    )
                )
            </if>

            <choose>
                <when test="sort == 'likes'">
                    ORDER BY P_SUB.LIKE_COUNT DESC, P_SUB.POST_ID DESC
                </when>
                <when test="sort == 'views'">
                    ORDER BY P_SUB.VIEW_COUNT DESC, P_SUB.POST_ID DESC
                </when>
                <otherwise>
                    ORDER BY P_SUB.POST_ID DESC
                </otherwise>
            </choose>
            
            OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
        ) p
        LEFT JOIN MEMBER u ON p.USER_NUM = u.USER_NUM
        LEFT JOIN FILEAT f ON p.POST_ID = f.POST_ID

        <choose>
            <when test="sort == 'likes'">
                ORDER BY p.LIKE_COUNT DESC, p.POST_ID DESC, NVL(f.FILE_ORDER, 0) ASC
            </when>
            <when test="sort == 'views'">
                ORDER BY p.VIEW_COUNT DESC, p.POST_ID DESC, NVL(f.FILE_ORDER, 0) ASC
            </when>
            <otherwise>
                ORDER BY p.POST_ID DESC, NVL(f.FILE_ORDER, 0) ASC
            </otherwise>
        </choose>
    </select>

	<insert id="insertPostLike" parameterType="map">
		INSERT INTO LIKES
		(POST_ID, USER_NUM, CREATED_DATE) VALUES (#{postId},
		#{userNum},
		SYSDATE)
	</insert>
	<delete id="deletePostLike" parameterType="map">
		DELETE FROM LIKES
		WHERE POST_ID = #{postId} AND USER_NUM = #{userNum}
	</delete>
	<select id="countPostLike" parameterType="Long"
		resultType="Integer">
		SELECT COUNT(*) FROM LIKES WHERE POST_ID = #{postId}
	</select>
	<update id="updatePostLikeCount" parameterType="Long">
		UPDATE POSTS SET
		LIKE_COUNT = (SELECT COUNT(*) FROM LIKES WHERE POST_ID =
		#{postId})
		WHERE POST_ID = #{postId}
	</update>
	<select id="checkPostLiked" parameterType="map"
		resultType="Integer">
		SELECT COUNT(*) FROM LIKES WHERE POST_ID = #{postId} AND
		USER_NUM =
		#{userNum}
	</select>

	<insert id="insertComment"
		parameterType="com.hs.model.CommentDTO">
		INSERT INTO COMMENTS (
		COMMENT_ID, POST_ID, USER_NUM,
		USER_ID, CONTENT,
		PARENT_COMMENT_ID, CREATED_DATE, IS_DELETED
		) VALUES (
		SEQ_COMMENTS.NEXTVAL, #{postId}, #{userNum}, #{userId}, #{content},
		NULLIF(#{parentCommentId}, 0), SYSDATE, '0'
		)
	</insert>

	<update id="updateComment"
		parameterType="com.hs.model.CommentDTO">
		UPDATE COMMENTS
		SET CONTENT = #{content}, UPDATED_DATE =
		SYSDATE
		WHERE COMMENT_ID = #{commentId} AND USER_NUM = #{userNum}
	</update>

	<delete id="deleteComment" parameterType="Long">
		DELETE FROM COMMENTS
		WHERE COMMENT_ID = #{commentId}
	</delete>

	<select id="listComment" parameterType="map"
		resultType="com.hs.model.CommentDTO">
		SELECT
		c.COMMENT_ID AS commentId,
		c.POST_ID AS postId,
		c.USER_NUM AS userNum,
		c.CONTENT AS content,
		TO_CHAR(c.CREATED_DATE, 'YYYY-MM-DD HH24:MI') AS createdDate,
		c.PARENT_COMMENT_ID AS
		parentCommentId,
		c.IS_DELETED AS isDeleted,
		m.USER_NICKNAME AS
		userNickName,
		m.USER_PROFILE AS profileImage,
		(SELECT COUNT(*) FROM
		COMMENTS_LIKES cl WHERE cl.COMMENT_ID = c.COMMENT_ID)
		AS likeCount,
		NVL((SELECT COUNT(*) FROM COMMENTS_LIKES cl WHERE cl.COMMENT_ID =
		c.COMMENT_ID
		AND cl.USER_NUM = #{userNum}), 0) AS likedByUser
		FROM
		COMMENTS c
		JOIN MEMBER m ON c.USER_NUM = m.USER_NUM
		WHERE c.POST_ID =
		#{postId}
		START WITH c.PARENT_COMMENT_ID IS NULL
		CONNECT BY PRIOR
		c.COMMENT_ID = c.PARENT_COMMENT_ID
		ORDER SIBLINGS BY c.CREATED_DATE ASC
	</select>

	<update id="updatePostCommentCount" parameterType="long">
		UPDATE POSTS
		SET COMMENT_COUNT = (
		SELECT COUNT(*)
		FROM COMMENTS
		WHERE POST_ID =
		#{postId} AND IS_DELETED = '0'
		)
		WHERE POST_ID = #{postId}
	</update>

	<insert id="insertCommentLike" parameterType="map">
		INSERT INTO
		COMMENTS_LIKES (COMMENT_ID, USER_NUM, CREATED_DATE) VALUES
		(#{commentId}, #{userNum}, SYSDATE)
	</insert>
	<delete id="deleteCommentLike" parameterType="map">
		DELETE FROM
		COMMENTS_LIKES WHERE COMMENT_ID = #{commentId} AND USER_NUM =
		#{userNum}
	</delete>
	<select id="countCommentLike" parameterType="Long"
		resultType="Integer">
		SELECT COUNT(*) FROM COMMENTS_LIKES WHERE COMMENT_ID =
		#{commentId}
	</select>
	<select id="checkCommentLiked" parameterType="map"
		resultType="Integer">
		SELECT COUNT(*) FROM COMMENTS_LIKES WHERE COMMENT_ID =
		#{commentId} AND
		USER_NUM = #{userNum}
	</select>

	<select id="getPostIdByCommentId" parameterType="long"
		resultType="long">
		SELECT POST_ID FROM COMMENTS WHERE COMMENT_ID = #{commentId}
	</select>

	<insert id="insertReport" parameterType="com.hs.model.ReportDTO">
    INSERT INTO Report (
        report_num, report_user_num, report_reason, 
        report_type, report_content, report_date
    ) VALUES (
        SEQ_REPORT.NEXTVAL, #{reportUserNum}, #{reportReason},
        #{reportType}, #{reportContent}, SYSDATE
    )
	</insert>

	<update id="updatePostReportCount" parameterType="long">
	    UPDATE POSTS 
	    SET REPORT_COUNT = NVL(REPORT_COUNT, 0) + 1
	    WHERE POST_ID = #{postId}
	</update>
	
	<select id="checkReportHistory" parameterType="map" resultType="int">
	    SELECT COUNT(*) FROM Report
	    WHERE report_user_num = #{userNum} 
	      AND report_content = TO_CHAR(#{postId})
	      AND report_type = 'POST'
	</select>
</mapper>